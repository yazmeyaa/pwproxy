user nginx;
worker_processes auto;
error_log /dev/stderr warn;

events {
    worker_connections 1024;
}

stream {
    # Резолвим через публичные DNS — получаем РЕАЛЬНЫЕ IP серверов (не IP прокси)
    resolver 1.1.1.1 8.8.8.8 valid=30s ipv6=off;
    resolver_timeout 5s;

    log_format proxy '$remote_addr [$time_local] '
                     '$protocol $status $bytes_sent $bytes_received '
                     '$session_time -> "$ssl_preread_server_name" '
                     'upstream: $upstream_addr';

    access_log /dev/stdout proxy;

    server {
        listen 443;
        ssl_preread on;

        proxy_connect_timeout 10s;
        proxy_timeout 120s;

        # Читаем SNI из TLS ClientHello и проксируем на реальный сервер
        proxy_pass $ssl_preread_server_name:443;
    }
}

