load_module /etc/nginx/modules/ngx_stream_module.so;

user nginx;
worker_processes auto;
error_log /dev/stderr warn;

events {
    worker_connections 1024;
}

stream {
    # Docker DNS (127.0.0.11) резолвит:
    #   - имена контейнеров (coredns → IP контейнера)
    #   - внешние домены (форвардит в DNS хоста → реальные IP)
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    log_format proxy '$remote_addr [$time_local] '
                     '$protocol $status $bytes_sent $bytes_received '
                     '$session_time -> "$ssl_preread_server_name" '
                     'upstream: $upstream_addr';

    access_log /dev/stdout proxy;

    # Роутинг по SNI:
    #   - DoH домен → CoreDNS (порт 8053, TLS терминируется на CoreDNS)
    #   - Всё остальное → проксируем на реальный сервер
    map $ssl_preread_server_name $backend {
        pwproxy.magic-lizard.ru coredns:8053;
        default                 $ssl_preread_server_name:443;
    }

    server {
        listen 443;
        ssl_preread on;

        proxy_connect_timeout 10s;
        proxy_timeout 300s;

        proxy_pass $backend;
    }
}
