global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    timeout connect 10s
    timeout client  300s
    timeout server  300s

resolvers upstream_dns
    nameserver ns1 1.1.1.1:53
    nameserver ns2 8.8.8.8:53
    resolve_retries 3
    timeout resolve 5s
    timeout retry   3s
    hold valid      60s

frontend ft_ssl
    bind *:443

    acl is_intercepted req_ssl_sni -i pw.game
    acl is_intercepted req_ssl_sni -i ns.photonengine.io
    acl is_intercepted req_ssl_sni -m end -i .exitgames.com
    acl is_intercepted req_ssl_sni -m reg -i ^notpix-3d-content\.[^.]+\.digitaloceanspaces\.com$
    acl is_intercepted req_ssl_sni -m reg -i ^not-platform\.[^.]+\.cdn\.digitaloceanspaces\.com$

    tcp-request inspect-delay 5s
    tcp-request content do-resolve(txn.dstip,upstream_dns,ipv4) req.ssl_sni if is_intercepted
    tcp-request content set-dst var(txn.dstip) if { var(txn.dstip) -m found }
    tcp-request content set-dst-port int(443) if { var(txn.dstip) -m found }
    tcp-request content accept if { req_ssl_hello_type 1 }

    use_backend bk_passthrough if is_intercepted
    default_backend bk_deny

backend bk_passthrough
    server upstream 0.0.0.0:0

backend bk_deny
    mode tcp
