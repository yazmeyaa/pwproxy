global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    timeout connect 10s
    timeout client  300s
    timeout server  300s

resolvers upstream_dns
    nameserver ns1 1.1.1.1:53
    nameserver ns2 8.8.8.8:53
    resolve_retries 3
    timeout resolve 5s
    timeout retry   3s
    hold valid      60s

frontend ft_ssl
    bind *:443

    acl is_wildcard req_ssl_sni -m end -i .exitgames.com
    acl is_wildcard req_ssl_sni -m reg -i ^notpix-3d-content\.[^.]+\.digitaloceanspaces\.com$
    acl is_wildcard req_ssl_sni -m reg -i ^not-platform\.[^.]+\.cdn\.digitaloceanspaces\.com$

    tcp-request inspect-delay 5s
    tcp-request content do-resolve(txn.dstip,upstream_dns,ipv4) req.ssl_sni if is_wildcard
    tcp-request content set-dst var(txn.dstip) if { var(txn.dstip) -m found }
    tcp-request content set-dst-port int(443) if { var(txn.dstip) -m found }
    tcp-request content accept if { req_ssl_hello_type 1 }

    use_backend bk_pw_game  if { req_ssl_sni -i pw.game }
    use_backend bk_photon   if { req_ssl_sni -i ns.photonengine.io }
    use_backend bk_wildcard if is_wildcard
    default_backend bk_deny

backend bk_pw_game
    server srv1 pw.game:443 resolvers upstream_dns resolve-prefer ipv4 init-addr none

backend bk_photon
    server srv1 ns.photonengine.io:443 resolvers upstream_dns resolve-prefer ipv4 init-addr none

backend bk_wildcard
    server upstream 127.0.0.1:443

backend bk_deny
    mode tcp
