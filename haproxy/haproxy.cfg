global
    log stdout format raw local0
    maxconn 10000

resolvers myresolvers
    nameserver dns1 1.1.1.1:53
    nameserver dns2 8.8.8.8:53
    hold valid 10s

defaults
    log global
    mode tcp
    timeout connect 5s
    timeout client 2m
    timeout server 2m

frontend tls_in
    bind *:443
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }
    use_backend dns_backend if { req.ssl_sni -i pwproxy.magic-lizard.ru }
    use_backend game_backend if { req.ssl_sni -i pw.game }
    use_backend gcams_backend if { req.ssl_sni -m reg ^gcams[0-9]+\.exitgames\.com$ }
    use_backend photon_backend if { req.ssl_sni -i ns.photonengine.io }
    use_backend cdn_notpix if { req.ssl_sni -i notpix-3d-content.fra1.digitaloceanspaces.com }
    use_backend cdn_platform if { req.ssl_sni -i not-platform.fra1.cdn.digitaloceanspaces.com }
    default_backend game_backend

backend dns_backend
    server dns coredns:443 check

backend game_backend
    server game pw.game:443 resolvers myresolvers resolve-prefer ipv4 check init-addr last,libc

backend gcams_backend
    # server-template creates 20 server slots that can be dynamically resolved
    # Each gcamsN.exitgames.com host matched by the frontend regex can be routed here.
    # For a fixed set of known gcams servers, list them explicitly:
    server-template gcams 20 _gcams._tcp.exitgames.com:443 resolvers myresolvers resolve-prefer ipv4 init-addr none check
    # ^^^ If SRV records don't work, replace with explicit servers:
    # server gcams1 gcams1.exitgames.com:443 resolvers myresolvers resolve-prefer ipv4 check
    # server gcams2 gcams2.exitgames.com:443 resolvers myresolvers resolve-prefer ipv4 check
    # ... etc.

backend photon_backend
    server photon ns.photonengine.io:443 resolvers myresolvers resolve-prefer ipv4 check init-addr last,libc

backend cdn_notpix
    server cdn1 notpix-3d-content.fra1.digitaloceanspaces.com:443 resolvers myresolvers resolve-prefer ipv4 check init-addr last,libc

backend cdn_platform
    server cdn2 not-platform.fra1.cdn.digitaloceanspaces.com:443 resolvers myresolvers resolve-prefer ipv4 check init-addr last,libc
